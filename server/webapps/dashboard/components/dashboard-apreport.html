<div class="row" style="margin-top: 20px ">
    <div class="col-lg-12">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>Access Point Report</h5>

                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                    <a class="close-link">
                        <i class="fa fa-times"></i>
                    </a>
                </div>
            </div>
            <div class="ibox-content">
                <table id="accesspoint" class="table table-striped table-bordered table-hover dataTables-accesspoint">
                    <thead>
                    <tr>
                        <th>AP mac</th>
                        <th>AP Name</th>
                        <th>Total Uploads</th>
                        <th>Total Downloads</th>
                        <th>Total Sessions</th>
                        <th>Total Users</th>
                        <th>Avg Data Usage per User</th>
                        <th>Avg User session time</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Downloads and Uploads -->
<section id={{widgetid}} class="widget-container secondone">
    <div class="row" id="map-body">
        <div class="col-lg-12">
            <div class="row map-containner">
                <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <div class="jarviswidget" id="wid-id-0" data-widget-refresh="2000" data-widget-colorbutton="false">
                        <header>
                            <h2>Location Map</h2>
                        </header>
                        <div>
                            <!-- widget edit box -->
                            <div class="jarviswidget-editbox">
                                <!-- This area used as dropdown edit box -->
                                <input class="form-control" type="text">
                                <span class="note"><i class="fa fa-check text-success"></i> Change title to update and save instantly!</span>
                            </div>
                            <!-- end widget edit box -->
                            <!-- widget content -->
                            <div class="widget-body">
                                <div id="map"></div>
                            </div>
                            <div id="heatmap-controlers">
                                <div class="col-sm-4">
                                    <div id="radius-label">radius: 20</div>
                                    <div id="radius-slider"></div>
                                </div>
                                <div class="col-sm-4">
                                    <div id="opacity-label">opacity: 0.5</div>
                                    <div id="opacity-slider"></div>
                                </div>
                                <div class="col-sm-4">
                                    <div id="max-label">max: -</div>
                                    <div id="max-slider"></div>
                                </div>
                            </div>
                            <!-- end widget content -->
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </div>
    <div class="row">
        <article class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
            <div class="jarviswidget" id="wid-id-1" data-widget-refresh="2000"
                 data-widget-load="components/widgets/apsummary-inuploads-series.html" data-widget-colorbutton="false"
                 data-id="apsummary-inuploads">
                <header>
                    <h2>Top 10 Access Point By Total Uploads</h2>
                </header>
                <div>
                    <!-- widget edit box -->
                    <div class="jarviswidget-editbox">
                        <!-- This area used as dropdown edit box -->
                        <input class="form-control" type="text">
                        <span class="note"><i class="fa fa-check text-success"></i> Change title to update and save instantly!</span>
                    </div>
                    <!-- end widget edit box -->

                    <!-- widget content -->
                    <div class="widget-body toptenap-widgets">
                        <div>
                            <div class="sk-spinner sk-spinner-three-bounce">
                                <div class="sk-bounce1"></div>
                                <div class="sk-bounce2"></div>
                                <div class="sk-bounce3"></div>
                            </div>
                        </div>
                    </div>
                    <!-- end widget content -->
                </div>
            </div>
        </article>
        <article class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
            <div class="jarviswidget" id="wid-id-2" data-widget-refresh="2000"
                 data-widget-load="components/widgets/apsummary-indownloads-series.html" data-widget-colorbutton="false"
                 data-id="apsummary-indownloads">
                <header>
                    <h2>Top 10 Access Point By Total Downloads</h2>
                </header>
                <div>
                    <!-- widget edit box -->
                    <div class="jarviswidget-editbox">
                        <!-- This area used as dropdown edit box -->
                        <input class="form-control" type="text">
                        <span class="note"><i class="fa fa-check text-success"></i> Change title to update and save instantly!</span>
                    </div>
                    <!-- end widget edit box -->

                    <!-- widget content -->
                    <div class="widget-body toptenap-widgets">
                        <div>
                            <div class="sk-spinner sk-spinner-three-bounce">
                                <div class="sk-bounce1"></div>
                                <div class="sk-bounce2"></div>
                                <div class="sk-bounce3"></div>
                            </div>
                        </div>
                    </div>
                    <!-- end widget content -->
                </div>
            </div>
        </article>
    </div>
</section>
<script>
    $(document).ready(function () {

        var map, heatmap;
        var apDataArray = [];
        var longlatDataArray = [];
        var allMarkers = [];
        var infoBoxes = [];
        var fullscreenchartid;

        var dropDownSelection = 1;

        var serverOriginUrl = window.location.origin;

        initializeWidgets();
        pageSetUp();

        function initializeWidgets() {
            $('#widget-grid').jarvisWidgets({
                toggleClass: 'fa fa-minus | fa fa-plus',
                deleteClass: 'fa fa-times',
                editClass: 'fa fa-cog | fa fa-save',
                fullscreenClass: 'fa fa-expand | fa fa-compress',
                refreshButtonClass: 'fa fa-refresh',
                grid: 'article',
                onFullscreen: function () {
                    if (!fullscreenchartid) {
                        var selectedwidgetid = $("#jarviswidget-fullscreen-mode >:first-child").data("id");
                        fullscreenchartid = selectedwidgetid;
                        $("#" + selectedwidgetid).highcharts().reflow();
                    } else {
                        $("#" + fullscreenchartid).highcharts().reflow();
                        fullscreenchartid = "";
                    }
                }
            });
        }

        function formatBytes(bytes) {
            return numeral(bytes).format('0.00b')
        }

        function formatIntoMinitue(time) {
            return Math.floor(time / 60) + " Min";
        }

        var accespointTable = $('.dataTables-accesspoint').DataTable({
            responsive: true,
            orderCellsTop: true,
            autoWidth: false,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
            "ajax": {
                "url": serverOriginUrl + "/wifi/summary/accespoint",
                "type": "POST",
                "contentType": "application/json",
                "data": function (d) {
                    return JSON.stringify(window.payload);
                },
                "error": function (e) {
                },
                "dataSrc": function (d) {
                    formatAPData(d);
                    initMap();
                    return apDataArray;
                }
            },
            columns: [
                {"data": "calledstationmac", "width": "10%"},
                {"data": "apname", "width": "10%"},
                {"data": "totaloutputoctets", "width": "8%"},
                {"data": "totalinputoctets", "width": "8%"},
                {"data": "totalsessions", "width": "5%"},
                {"data": "totalusers", "width": "5%"},
                {"data": "avgdataperuser", "width": "8%"},
                {"data": "avgdatapersessiontime", "width": "8%"}
            ],
            "columnDefs": [
                {
                    "render": function (data) {
                        return formatBytes(data);
                    },
                    "targets": 2
                },
                {
                    "render": function (data) {
                        return formatBytes(data);
                    },
                    "targets": 3
                },
                {
                    "render": function (data) {
                        return formatBytes(data);
                    },
                    "targets": 6
                },
                {
                    "render": function (data) {
                        return formatIntoMinitue(data);
                    },
                    "targets": 7
                }
            ],
            dom: "<'dt-toolbar'<'col-xs-12 col-sm-6'lf><'col-sm-6 col-xs-6 hidden-xs'CT>r>" +
            "t" +
            "<'dt-toolbar-footer'<'col-sm-6 col-xs-12 hidden-xs'i><'col-sm-6 col-xs-12'p>>",
            tableTools: {
                "aButtons": [
                    {
                        "sExtends": "copy",
                        "sButtonText": "Copy",
                        "mColumns": "visible"
                    },
                    {
                        "sExtends": "csv",
                        "sButtonText": "CSV",
                        "mColumns": "visible"
                    },
                    {
                        "sExtends": "xls",
                        "sButtonText": "Excel",
                        "mColumns": "visible"
                    },
                    {
                        "sExtends": "pdf",
                        "sButtonText": "PDF",
                        "mColumns": "visible"
                    },
                    {
                        "sExtends": "print",
                        "sButtonText": "Print",
                        "mColumns": "visible"
                    }
                ],
                "sSwfPath": "js/plugins/dataTables/swf/copy_csv_xls_pdf.swf"
            }
        });

        $('.dataTables-accesspoint tbody').on('click', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
            }
            else {
                accespointTable.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
                var accesPointData = accespointTable.row(this).data();
                var long = null, latitude = null;
                $.each(longlatDataArray, function (i, obj) {
                    if (obj.mac == accesPointData.calledstationmac) {
                        latitude = obj.latitude;
                        long = obj.longitude;
                        return false;
                    }
                });
                var selectedMarker = allMarkers[0];
                var selectedIndex = 0;
                var i = 0;
                allMarkers.forEach(function (marker) {
                    if (long == marker.position.lat() && latitude == marker.position.lng()) {
                        selectedMarker = marker;
                        selectedIndex = i;
                    } else {
                        infoBoxes[i].close();
                    }
                    i++;
                });
                map.setCenter(selectedMarker.position);
                infoBoxes[selectedIndex].open(map, selectedMarker);
            }
        });

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14,
                center: {lat: -33.865143, lng: 151.209900},
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                minZoom:4
            });
            new DropDownControl();

            generatePoistionAnchors(map, longlatDataArray, apDataArray);
            setupHeatMapData(dropDownSelection);
        }

        function setupHeatMapData(selection) {
            var index = 0;
            var formatedMax;
            var heatData = [];
            var dicAttr = { 1:'totalinputoctets', 2: 'totaloutputoctets', 3:'totalusers'};
            var max = apDataArray[0][dicAttr[selection]];
            apDataArray.forEach(function () {
                max = Math.max(max, apDataArray[index][dicAttr[selection]]);
                heatData.push({
                    location: new google.maps.LatLng(longlatDataArray[index].latitude, longlatDataArray[index].longitude),
                    weight: apDataArray[index][dicAttr[selection]]
                });
                index++;
            });
            if(selection == 1 || selection == 2){
                formatedMax = formatBytes(numberWithCommas(max))
            }else{
                formatedMax = numberWithCommas(max)
            }
            $("#max-label").html("max: "+ formatedMax);
            $("#max-slider").slider("option","max",max);
            $("#max-slider").slider("option","value",max);

            drawHeatmap(heatData)
        }

        function drawHeatmap(heatmapdata) {
            if(heatmap) heatmap.setMap(null);
            heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatmapdata,
                radius: $("#radius-slider").slider("value"),
                opacity: $("#opacity-slider").slider("value")
            });
            heatmap.setMap(map);
        }


        function toggleHeatmap() {
            heatmap.setMap(heatmap.getMap() ? null : map);
        }

        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }


        function DropDownControl() {
            var gMap = google.maps;
            var container = document.createElement("div");
            container.style.margin = "7px";
            container.id = "select_box";
            var selMap = document.createElement("select");
            selMap.id = "selMap";
            selMap.className = "form-control";
            selMap.title = "Change Map Type";

            selMap.options[0] = new Option("Toggle HeatMap", 0);
            selMap.options[1] = new Option("Download HeatMap", 1);
            selMap.options[2] = new Option("Upload HeatMap", 2);
            selMap.options[3] = new Option("User Density HeatMap", 3);

            selMap.selectedIndex = 1;

            container.appendChild(selMap);
            map.controls[gMap.ControlPosition.TOP_RIGHT].push(container);

            gMap.event.addDomListener(selMap, "change", function () {
                dropDownSelection = selMap.selectedIndex;
                if (dropDownSelection == 0) {
                    toggleHeatmap();
                } else {
                    setupHeatMapData(dropDownSelection)
                }
                this.blur();
            });
        }


        function generatePoistionAnchors(map, longlatObjs, apDataObjs) {
            for (var key in apDataObjs) {
                if (apDataObjs.hasOwnProperty(key)) {
                    var obj = longlatObjs[key];
                    var marker = new google.maps.Marker({
                        position: new google.maps.LatLng(obj.latitude, obj.longitude),
                        map: map
                    });
                    allMarkers.push(marker);
                    attachContentForInfobox(marker, apDataObjs[key]);
                }
            }
        }

        function attachContentForInfobox(marker, obj) {
            var renderdContent = "";
            $.get('components/widgets/featuredetails-widgets/location-map-details.html', function (template) {
                renderdContent = Mustache.render(template, {
                    totalsessions:  obj.totalsessions,
                    totalusers:  obj.totalusers,
                    avgdataperuser: formatBytes(obj.avgdataperuser),
                    avgdatapersessiontime: formatIntoMinitue(obj.avgdatapersessiontime),
                    totalinputoctets: formatBytes(obj.totalinputoctets),
                    totaloutputoctets:  formatBytes(obj.totaloutputoctets),
                    calledstationmac: obj.calledstationmac,
                    apname: obj.apname
                });
                var infowindow = new google.maps.InfoWindow({
                    content: renderdContent
                });
                infoBoxes.push(infowindow);
                marker.addListener('click', function () {
                    infowindow.open(marker.get('map'), marker);
                });
            });
        }

        function formatAPData(data) {
            for (ap in data) {
                apDataArray.push(data[ap].AccessPointData);
                longlatDataArray.push(data[ap].LongLatMacData);
            }
        }

        $(function() {
            $( "#heatmap-controlers" ).draggable({
                containment: "parent"
            });
            $("#radius-slider").slider({
                orientation: "horizontal",
                range: "min",
                min: 1,
                max: 50,
                value: 25,
                slide: function (event, ui) {
                    $("#radius-label").html("radius: " + ui.value);
                    if (heatmap == null) return;
                    heatmap.set('radius', ui.value);
                }
            });

            $("#opacity-slider").slider({
                orientation: "horizontal",
                range: "min",
                min: 0,
                max: 100,
                value: 50,
                slide: function (event, ui) {
                    $("#opacity-label").html("opacity: " + ui.value / 100);
                    if (heatmap == null) return;
                    heatmap.set('opacity', ui.value / 100);
                }
            });

            $("#max-slider").slider({
                orientation: "horizontal",
                range: "min",
                min: 0,
                max: 1,
                value: 0,
                slide: function (event, ui) {
                    var value = 0;
                    if (dropDownSelection == 1 || dropDownSelection == 2){
                        value = formatBytes(numberWithCommas(ui.value))
                    }else{
                        value = numberWithCommas(ui.value);
                    }
                    $("#max-label").html("max: " + value);
                    if (heatmap == null) return;
                    heatmap.set('maxIntensity', ui.value);
                }
            });
        });
    });

</script>
