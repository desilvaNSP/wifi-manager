<div class="row">
    <div  class="col-lg-12" align="center">
        <i class="fa fa-desktop fa-2x fa-icon-themcolor"></i>
        <h3 class="title">Radius Monitoring - AAA</h3>
        <small class="font-bold">Radius server monitoring capability to the dashboards</small>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="wrapper wrapper-content animated fadeInUp">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>Radius Client List</h5>
                    <div class="ibox-tools btn-tools">
                        <a href="#" id="add-radiusclient" class="btn btn-primary btn-sm">+ Add</a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="aaa-list-container">
                        <table class="table table-striped table-bordered table-hover dataTables-aaalist">
                            <thead>
                            <tr>
                                <th>Instance ID</th>
                                <th>Server Name</th>
                                <th>Server IP</th>
                                <th>Authentication Port</th>
                                <th>Shared Secret</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Update Radius server Configuration -->
<div class="modal inmodal" id="edit-radiuserver-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <h4 class="modal-title radius-modal-title">Update Radius Server</h4>
                <small>A RADIUS server is a network server implementing RADIUS and RADIUS-based authentication protocols</small>
            </div>
            <div class="modal-body" id="rad-editconfig-bodymodal">
                <form role="form" id="radiusconfigeditform">
                    <div class="form-group">
                        <label for="edit-server-name">Server Name</label>
                        <input type="text" class="form-control" id="edit-server-name" name="servername"
                               placeholder="Name" equired>
                    </div>
                    <div class="row">
                        <div class="form-group col-lg-6">
                            <label for="edit-serverip">Server IP</label>
                            <input type="text" class="form-control" id="edit-serverip" name="serverip"
                                   placeholder="Name" data-fv-ip="true" required>
                        </div>
                        <div class="form-group col-lg-6">
                            <label for="edit-auth-port">Authentication Port</label>
                            <input type="text" class="form-control" id="edit-auth-port" name="authport"
                                   placeholder="Name" value="1812"
                                   onblur="if (this.value == '') {this.value = '1812';}"
                                   onfocus="if (this.value == '1812') {this.value = '';}" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-lg-6">
                            <label for="edit-shared-secret">Shared Secret</label>
                            <input type="password" class="form-control" id="edit-shared-secret" name="sharedsecret"
                                   placeholder="Name" required>
                        </div>
                        <div class="form-group col-lg-6">
                            <label for="edit-confirm-secret">Confirm Shared Secret</label>
                            <input type="password" class="form-control" id="edit-confirm-secret" name="confirmsecret"
                                   placeholder="Name"  required>
                        </div>
                    </div>
                </form>
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="headingEdit">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" parent="#accordion" data- href="#collapse-testedituser" aria-expanded="false" aria-controls="collapse-testedituser">
                                Test User Authentication
                            </a>
                        </h4>
                    </div>
                    <div id="collapse-testedituser" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingEdit">
                        <div class="panel-body">
                            <form role="form" id="testedituserconform">
                                <div class="row">
                                    <div class="form-group col-lg-6">
                                        <label for="edit-radius-test-username">User Name</label>
                                        <input class="form-control" type="input" name="testusernameedit" id="edit-radius-test-username">
                                    </div>
                                    <div class="form-group col-lg-6">
                                        <label for="edit-radius-test-password">Password</label>
                                        <input class="form-control"  type="password" name="testpasswordedit" id="edit-radius-test-password">
                                    </div>
                                </div>
                                <div class="form-group col-lg-12" align="right">
                                    <button type="button " class="btn btn-primary" id="btn-edit-testconnection">Test Connection</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btn-edit-radiusclient">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Radius server Configuration -->
<div class="modal inmodal" id="radiuserver-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <h4 class="modal-title radius-modal-title">Create Radius Server</h4>
                <small>A RADIUS server is a network server implementing RADIUS and RADIUS-based authentication protocols</small>
            </div>
            <div class="modal-body" id="rad-config-bodymodal">
                <form role="form" id="radiusconfiginputform">
                    <div class="form-group">
                        <label for="input-server-name">Server Name</label>
                        <input type="text" class="form-control" id="input-server-name" name="servername"
                               placeholder="Name" required>
                    </div>
                    <div class="row">
                        <div class="form-group col-lg-6">
                            <label for="input-serverip">Server IP</label>
                            <input type="text" class="form-control" id="input-serverip" data-fv-ip-ipv4="true" name="serverip"
                                   placeholder="Name" required>
                        </div>
                        <div class="form-group col-lg-6">
                            <label for="input-auth-port">Authentication Port</label>
                            <input type="text" class="form-control" id="input-auth-port" name="authport"
                                   placeholder="Name" value="1812"
                                   onblur="if (this.value == '') {this.value = '1812';}"
                                   onfocus="if (this.value == '1812') {this.value = '';}" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-lg-6">
                            <label for="input-shared-secret">Shared Secret</label>
                            <input type="password" class="form-control" id="input-shared-secret" name="sharedsecret"
                                   placeholder="Name"  required>
                        </div>
                        <div class="form-group col-lg-6">
                            <label for="input-confirm-secret">Confirm Shared Secret</label>
                            <input type="password" class="form-control" id="input-confirm-secret" name="confirmsecret"
                                   placeholder="Name"  required>
                        </div>
                    </div>
                </form>
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="headingInput">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" parent="#accordion" data- href="#collapse-testinputuser" aria-expanded="false" aria-controls="collapse-testinputuser">
                                Test User Authentication
                            </a>
                        </h4>
                    </div>
                    <div id="collapse-testinputuser" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingInput">
                        <div class="panel-body">
                            <form role="form" id="testuserconform">
                                <div class="form-group col-lg-6">
                                    <label for="radius-test-username">User Name</label>
                                    <input class="form-control" type="input" name="testusername" id="radius-test-username">
                                </div>
                                <div class="form-group col-lg-6">
                                    <label for="radius-test-password">Password</label>
                                    <input class="form-control"  type="password" name="testpassword" id="radius-test-password">
                                </div>
                                <div class="form-group col-lg-12" align="right">
                                    <button type="button" class="btn btn-primary" id="btn-testconnection">Test Connection</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btn-add-radiusclient" >Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirm-deleteradius-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <h4 class="modal-title">Delete Radius Instance</h4>
            </div>
            <div class="modal-body" id="deleteradius-body">
                <p><strong>Are you sure you want to delete the location?</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">No</button>
                <button type="button" class="btn btn-primary" id="delete-radius-server">Yes</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function(){
        var serverOriginUrl = window.location.origin;

        var connEst = false;
        var data = [];
        var aaaTable;

        $.validator.addMethod('IP4Checker', function(value) {
            var ip = /^(25[0-5]|2[0-4][0-9]|[0-1][0-9]{2}|[0-9]{2}|[0-9])(\.(25[0-5]|2[0-4][0-9]|[0-1][0-9]{2}|[0-9]{2}|[0-9])){3}$/;
            return value.match(ip);
        }, 'Invalid IP address');

        var aaaListData;
        aaaTable = $('.dataTables-aaalist').DataTable( {
            ajax: {
                "url": serverOriginUrl + '/radius/' + Cookies.get('tenantid') + '/radiusdetails/' + Cookies.get("username"),
                "type": "GET",
                "error": function (e) {
                },
                "dataSrc": function (d) {
                    aaaListData = d;
                    return d
                }
            },
            columns: [
                { data: 'radiusinstid'},
                { data: 'servername' },
                { data: 'serverip' },
                { data: 'authport' },
                { data: 'secret' },
                {
                    "data": null,
                    "defaultContent": "<div class='btn-group'><button class='btn btn-white btn-xs dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'><i class='fa fa-gear'></i></button><ul class='dropdown-menu'><li><a href='#' id='setting-edit-radiusserver'>Edit</a></li><li><a href='#' id='setting-delete-radiusinst'>Delete</a></li></ul></div>",
                    "width": "1%",
                    "className": 'center',
                    "sortable": false
                }
            ]
        });

        var addradiusclientvalidator;
        var editradiusclientvalidator;
        var passwordvalidationinput;
        var passwordvalidationedit;

        passwordvalidationinput = $("#testuserconform").validate({
            rules: {
                testusername: {
                    required: true
                },
                testpassword: {
                    required: true
                }
            },
            messages:{
                testusername:{
                    required: "Pleasse enter username",
                },
                testpassword:{
                    required: "Pleasse enter password",
                },
            }
        });

        passwordvalidationedit = $("#testedituserconform").validate({
            rules: {
                testusernameedit: {
                    required: true
                },
                testpasswordedit: {
                    required: true
                }
            },
            messages:{
                testusernameedit:{
                    required: "Pleasse enter username",
                },
                testpasswordedit:{
                    required: "Pleasse enter password",
                }
            }
        });

        addradiusclientvalidator = $("#radiusconfiginputform").validate({
            rules: {
                servername: {
                    required: true,
                    minlength: 3,
                    maxlength: 25
                },
                serverip: {
                    required: true,
                    IP4Checker: true
                },
                authport: {
                    required: true,
                    number:true
                },
                sharedsecret: {
                    required: true,
                },
                confirmsecret: {
                    required: true,
                    equalTo: "#input-shared-secret",
                }
            },
            messages: {
                servername: {
                    required:"Please include server name for instance"
                },
                serverip: {
                    required:"Please enter a correct IP address"
                },
                authport: {
                    required: "Please enter port number for Authentication"
                },
                confirmsecret:{
                    required: "Pleasse confirm your Secret",
                    equalTo: "Unmatch secret"
                }
            }
        });
        editradiusclientvalidator = $("#radiusconfigeditform").validate({
            rules: {
                servername: {
                    required: true,
                    minlength: 3,
                    maxlength: 25
                },
                serverip: {
                    required: true,
                    IP4Checker: true
                },
                authport: {
                    required: true,
                    number:true
                },
                sharedsecret: {
                    required: true,
                },
                confirmsecret: {
                    required: true,
                    equalTo: "#edit-shared-secret",
                }
            },
            messages: {
                servername: {
                    required:"Please include server name for instance"
                },
                serverip: {
                    required:"Please enter a correct IP address"
                },
                authport: {
                    required: "Please enter port number for Authentication"
                },
                confirmsecret:{
                    required: "Pleasse confirm your Secret",
                    equalTo: "Unmatch secret"
                }
            }
        });

        $("#add-radiusclient").on('click', function () {
            $('#radiusconfiginputform').trigger('reset');
            $('#testuserconform').trigger('reset');
            addradiusclientvalidator.resetForm();
            passwordvalidationinput.resetForm()
            $("#radiuserver-modal").modal('show');
        });

        $("#btn-testconnection").on('click', function () {
            if($('#radiusconfiginputform').valid() && $('#testuserconform').valid()){
                var payload = {
                    tenantid : parseInt(Cookies.get("tenantid")),
                    username : Cookies.get("username"),
                    servername : $('#input-server-name').val(),
                    serverip: $('#input-serverip').val(),
                    authport: $('#input-auth-port').val(),
                    secret: $('#input-shared-secret').val(),
                    testusername: $('#radius-test-username').val(),
                    password: $('#radius-test-password').val()
                };
                connEst = false;
                $("#rad-config-bodymodal").loadingOverlay({
                    loadingText: 'Creating Radius Server'
                });
                $.post('/radius/user/connection',JSON.stringify(payload), function (result) {
                    connEst = result;
                    if (connEst){
                        bootbox.alert("Healthy Connection", null);
                    }else{
                        bootbox.alert("Healthy Connection", null);
                    }
                    $("#rad-config-bodymodal").loadingOverlay('remove');
                });
            }
        });

        $("#btn-add-radiusclient").on('click', function () {
            if ($('#radiusconfiginputform').valid()) {
                var payload = {
                    tenantid: parseInt(Cookies.get("tenantid")),
                    username: Cookies.get("username"),
                    servername: $('#input-server-name').val(),
                    serverip: $('#input-serverip').val(),
                    authport: $('#input-auth-port').val(),
                    secret: $('#input-shared-secret').val(),
                    testusername: $('#radius-test-username').val(),
                    password: $('#radius-test-password').val()
                };

                $("#rad-config-bodymodal").loadingOverlay({
                        loadingText: 'Creating Radius Server'
                });
                $.post('/radius/user/connection',JSON.stringify(payload), function (result) {
                    connEst = result;
                    if (connEst){
                        $.post('/radius/createserver', JSON.stringify(payload), function (result) {
                            $("#radiuserver-modal").modal('hide');
                            $("#rad-config-bodymodal").loadingOverlay('remove');
                            aaaTable.ajax.reload();
                            bootbox.alert("Succesfully Saved!" + payload.servername +" AAA server configured ", null);
                        });
                    }else{
                        $("#radiuserver-modal").modal('hide');
                        $("#rad-config-bodymodal").loadingOverlay('remove');
                        bootbox.dialog({
                            message: "<div class='alert alert-warning'>Do you still want to save the AAA parameters</div>",
                            title: "Connection Testing Failed !",
                            buttons: {
                                success: {
                                    label: "Confirm!",
                                    className: "btn-primary",
                                    callback: function() {
                                        $.post('/radius/createserver', JSON.stringify(payload), function (result) {
                                            aaaTable.ajax.reload();
                                        });
                                    }
                                },
                                danger: {
                                    label: "Cancel!",
                                    className: "btn-default",
                                    callback: function() {
                                    }
                                }
                            }
                        });
                    }
                });

            }
        });

        var currentUpdateRow;
        var selectedRadiusInstance;

        $('#delete-radius-server').on("click", function (event) {
            $.ajax({
                url: '/radius/' + Cookies.get('tenantid') + '/radiusdetails/' + selectedRadiusInstance.radiusinstid,
                type: 'DELETE',
                beforeSend:function(){
                    $("#deleteradius-body").loadingOverlay({
                        loadingText: 'Deleting Radius Server'
                    });
                },
                success: function (result) {
                    $("#deleteradius-body").loadingOverlay('remove');
                    $('#confirm-deleteradius-modal').modal('hide');
                    aaaTable.ajax.reload();
                },
                error: function (e) {
                    console.log(e)
                }
            });
            return false;
        });

        $('.dataTables-aaalist tbody').on('click', '#setting-delete-radiusinst', function () {
            selectedRadiusInstance = aaaTable.row($(this).parents('tr')).data();
            $('#confirm-deleteradius-modal').modal()
        });


        $('.dataTables-aaalist tbody').on('click', '#setting-edit-radiusserver', function () {
            editradiusclientvalidator.resetForm();
            passwordvalidationedit.resetForm();
            currentUpdateRow = $(this).parents('tr');
            selectedRadiusInstance = aaaTable.row($(this).parents('tr')).data();
            $('#edit-server-name').val(selectedRadiusInstance.servername);
            $('#edit-serverip').val(selectedRadiusInstance.serverip);
            $('#edit-auth-port').val(selectedRadiusInstance.authport);
            $('#edit-shared-secret').val(selectedRadiusInstance.secret);
            $('#testuserconform').trigger('reset');
            $('#edit-radiuserver-modal').modal('show');
        });

        $("#btn-edit-testconnection").on('click', function () {
            if ($('#radiusconfigeditform').valid() && $('#testedituserconform').valid()){
                var payload = {
                    tenantid : parseInt(Cookies.get("tenantid")),
                    username : Cookies.get("username"),
                    servername : $('#edit-server-name').val(),
                    serverip: $('#edit-serverip').val(),
                    authport: $('#edit-auth-port').val(),
                    secret: $('#edit-shared-secret').val(),
                    testusername: $('#edit-radius-test-username').val(),
                    password: $('#edit-radius-test-password').val()
                };
                connEst = false;
                $.post('/radius/user/connection',JSON.stringify(payload), function (result) {
                    connEst = result;
                    if (connEst){
                        bootbox.alert("Healthy Connection", null);
                    }else{
                        bootbox.alert("Radius Server Authentication Failed", null);
                    }
                });
            }
        });

        $("#btn-edit-radiusclient").on("click", function (event) {
            if ($('#radiusconfigeditform').valid()) {
                var payload = {
                    tenantid: parseInt(Cookies.get("tenantid")),
                    username: Cookies.get("username"),
                    servername: $('#edit-server-name').val(),
                    serverip: $('#edit-serverip').val(),
                    authport: $('#edit-auth-port').val(),
                    secret: $('#edit-shared-secret').val(),
                    testusername: $('#edit-radius-test-username').val(),
                    password: $('#edit-radius-test-password').val()
                };
                $("#rad-editconfig-bodymodal").loadingOverlay({
                    loadingText: 'Updating Radius Server'
                });
                $.post('/radius/user/connection',JSON.stringify(payload), function (result) {
                    connEst = result;
                    if (connEst){
                        toastr.success("Healthy Connection");
                        $.ajax({
                            url: '/radius/' + Cookies.get('tenantid') + '/radiusdetails/' + selectedRadiusInstance.radiusinstid,
                            type: 'PUT',
                            data: JSON.stringify(payload),
                            success: function () {
                                $("#rad-editconfig-bodymodal").loadingOverlay('remove');
                                $("#edit-radiuserver-modal").modal('hide');
                                bootbox.alert("Succesfully Saved! " + payload.servername +" AAA server configured ", null);
                                aaaTable.ajax.reload();
                            },
                            error: function (e) {
                                console.log(e)
                            }
                        });
                    }else{
                        $("#rad-editconfig-bodymodal").loadingOverlay('remove');
                        $("#edit-radiuserver-modal").modal('hide');
                        bootbox.dialog({
                            message: "<div class='alert alert-warning'>Do you still want to save the AAA parameters</div>",
                            title: "Connection Testing Failed !",
                            class:"alert-message-boot",
                            buttons: {
                                success: {
                                    label: "Confirm!",
                                    className: "btn-primary",
                                    callback: function() {
                                        $.ajax({
                                            url: '/radius/' + Cookies.get('tenantid') + '/radiusdetails/' + selectedRadiusInstance.radiusinstid,
                                            type: 'PUT',
                                            data: JSON.stringify(payload),
                                            success: function () {
                                                aaaTable.ajax.reload();
                                            },
                                            error: function (e) {
                                                console.log(e)
                                            }
                                        });
                                    }
                                },
                                danger: {
                                    label: "Cancel!",
                                    className: "btn-default",
                                    callback: function() {
                                    }
                                }
                            }
                        });
                    }
                });
            }
        });

    });
</script>


