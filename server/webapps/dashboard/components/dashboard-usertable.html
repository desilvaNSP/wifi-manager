<div class="col-lg-12">
    <div class="ibox float-e-margins">
        <div class="ibox-title">
            <h5>Dashboard user table</h5>

            <div class="ibox-tools">
                <a class="collapse-link">
                    <i class="fa fa-chevron-up"></i>
                </a>
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                    <i class="fa fa-wrench"></i>
                </a>
                <ul class="dropdown-menu dropdown-user">
                    <li><a href="#" id="add-user-opt">Add User</a></li>
                </ul>
                <a class="close-link">
                    <i class="fa fa-times"></i>
                </a>
            </div>
        </div>
        <div class="ibox-content">

            <table class="table table-striped table-bordered table-hover dataTables-user">
                <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Acct Status</th>
                    <th>Settings</th>
                </tr>
                </thead>
            </table>

        </div>
    </div>
</div>

<div class="modal fade" id="confirm-delete-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <h4 class="modal-title" style="text-align: center">Delete User</h4>
            </div>
            <div class="modal-body">
                <p id="message"><strong>Are you sure you want to delete the user?</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">No</button>
                <button type="button" class="btn btn-primary" id="btn-delete-user">Yes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal inmodal" id="adduser-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <i class="fa fa-user-md modal-icon"></i>
                <h4 class="modal-title">Add User</h4>
                <small class="font-bold">Add system users and assign privileges</small>
            </div>
            <div class="modal-body">
                <form role="form" id="adduser-form">
                    <div class="form-group">
                        <label for="inputTenantDomain">Tenant Domain</label>
                        <input type="text" class="form-control" id="inputTenantDomain" name="tenantdomain" value="{{tenantDomain}}" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="inputUsername">Username</label>
                        <input type="text" class="form-control" id="inputUsername" name="username"
                               placeholder="Username" required>
                    </div>
                    <div class="form-group">
                        <label for="inputEmail">Email address</label>
                        <input type="email" class="form-control" id="inputEmail" name="email" placeholder="Email"
                               required>
                    </div>
                    <div class="form-group">
                        <label for="inputPassword">Password</label>
                        <input type="password" class="form-control" id="inputPassword" name="password"
                               placeholder="Password" required>
                    </div>
                    <div class="form-group">
                        <label for="inputPassword">Confirm Password</label>
                        <input type="password" class="form-control" id="inputConfirmPassword" name="confirmpassword"
                               placeholder="Confirm Password" required>
                    </div>
                    <div class="form-group">
                        <label for="inputPassword">Roles</label>

                        <div class="checkbox">
                            {{#roles}}
                            <label class="radio inline control-label"><input type="radio" class="radio"
                                                                             name="role-select" value="{{name}}">{{name}}</label><br/>
                            {{/roles}}
                        </div>
                    </div>
                    <div class="form-group">
                        <label >Allowed Data Scopes</label>

                        <div class="checkbox">
                            <div class="row">
                                {{#permissions}}
                                <div class="col-sm-6">
                                    <label>
                                        <input type="checkbox" name="datascope" value="{{.}}">{{.}}
                                    </label>
                                </div>
                                {{/permissions}}
                            </div>
                        </div>
                    </div>
                    <div class="checkbox">
                        <hr/>
                        <label>
                            <input type="checkbox" id="chkIsActive"> Activate
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btn-add-user">Add User</button>
            </div>
        </div>
    </div>
</div>

<div class="modal inmodal" id="edituser-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <i class="fa fa-user-md modal-icon"></i>
                <h4 class="modal-title">Edit User</h4>
                <small class="font-bold">Edit system users and assign privileges</small>
            </div>
            <div class="modal-body">
                <form role="form" id="edituser-form">
                    <div class="form-group">
                        <label for="inputEditTenantDomain">Tenant Domain</label>
                        <input type="text" class="form-control" id="inputEditTenantDomain" name="tenantdomain" value="{{tenantDomain}}" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="inputEditUsername">Username</label>
                        <input type="text" class="form-control" id="inputEditUsername" name="editusername"
                               placeholder="Username" required readonly="readonly">
                    </div>
                    <div class="form-group">
                        <label for="inputEditEmail">Email address</label>
                        <input type="email" class="form-control" id="inputEditEmail" name="editemail"
                               placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <label for="inputPassword">Roles</label>
                        <div class="checkbox">
                            {{#roles}}
                            <label class="radio inline control-label"><input type="radio" class="radio"
                                                                             name="role-select" value="{{name}}">{{name}}</label><br/>
                            {{/roles}}
                        </div>
                    </div>
                    <div class="checkbox">
                        <hr/>
                        <label>
                            <input type="checkbox" id="chkEditIsActive"> Activate
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btn-edit-user">Update User</button>
            </div>
        </div>
    </div>
</div>

<script src="js/plugins/validate/jquery.validate.min.js"></script>
<script>
    $(document).ready(function () {
        var serverOriginUrl = window.location.origin;
        var userTable = $('.dataTables-user').DataTable({
            orderCellsTop: true,
            ajax: {
                "url": serverOriginUrl + "/dashboard/" + Cookies.get("tenantid") + "/users",
                "type": "GET",
                "dataSrc": function (d) {
                    return d
                }
            },
            columns: [
                {"data": "username", "width": "15%"},
                {"data": "email", "width": "10%"},
                {"data": "status", "width": "5%"},
                {
                    "data": null,
                    "defaultContent": "<div class='btn-group'><button class='btn btn-white btn-xs dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'><i class='fa fa-gear'></i></button><ul class='dropdown-menu'><li><a href='#' id='setting-edit-user'>Edit</a></li><li><a href='#' id='setting-change-password'>Change Password</a></li><li><a href='#' id='setting-delete-user'>Delete</a></li></ul></div>",
                    "width": "1%",
                    "className": 'center'
                },
            ],
            dom: 'T<"clear">lfrtip',
            tableTools: {
                "sSwfPath": "js/plugins/dataTables/swf/copy_csv_xls_pdf.swf"
            }
        });

        var adduserFromValidator = $("#adduser-form").validate({
            rules: {
                password: {
                    required: true,
                    minlength: 5
                },
                confirmpassword: {
                    required: true,
                    equalTo: "#inputPassword",
                    minlength: 5
                },
                username: {
                    required: true,
                    minlength: 3
                },
                email: {
                    required: true,
                    email: true
                }
            }
        });

        var editUserFromValidator = $("#edituser-form").validate({
            rules: {
                editusername: {
                    required: true,
                    minlength: 3
                },
                editemail: {
                    required: true,
                    email: true
                }
            }
        });

        $('.dataTables-user tbody').on('click', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
            }
            else {
                userTable.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
            }
        });

        var selectedUser, rawTodelete;
        $('#btn-delete-user').on("click", function (event) {
            $.ajax({
                url: '/dashboard/' + Cookies.get('tenantid') + '/users/' + selectedUser.username,
                type: 'DELETE',
                success: function (result) {
                    $('#confirm-delete-modal').modal('hide');
                    rawTodelete.remove();
                },
                error: function (e) {
                    console.log(e)
                }
            });
            return false;
        });

        $('.dataTables-user tbody').on('click', '#setting-delete-user', function () {
            rawTodelete = $(this).closest('tr');
            selectedUser = userTable.row($(this).parents('tr')).data();
            $('#confirm-delete-modal').modal()
            $('#message').html('<i class="fa fa-warning fa-3x" style="vertical-align: middle;margin-right: 10%"></i>Are you sure you want to delete the user? <strong>' + selectedUser.username + '</strong>');
        });

        $('.dataTables-user tbody').on('click', '#setting-edit-user', function () {
            selectedUser = userTable.row($(this).parents('tr')).data();
            editUserFromValidator.resetForm();
            $('#edituser-modal').modal()
            $("#inputEditUsername").val(selectedUser.username);
            $("#inputEditEmail").val(selectedUser.email);
            if (selectedUser.status == 'active') {
                $("#chkEditIsActive").prop('checked', true);
            } else {
                $("#chkEditIsActive").prop('checked', false);
            }
        });

        $('#btn-edit-user').on("click", function (event) {
            if ($("#edituser-form").valid()) {
                var newUserStatus = 'pending';
                if ($('#chkEditIsActive').is(":checked")) {
                    newUserStatus = 'active';
                }
                var payload = {
                    tenantid: parseInt(Cookies.get('tenantid')),
                    username: $('#inputEditUsername').val(),
                    email: $('#inputEditEmail').val(),
                    roles: [$('.radio:checked').val()],
                    status: newUserStatus
                }

                $.ajax({
                    url: '/dashboard/users',
                    type: 'PUT',
                    contentType: "application/json",
                    data: JSON.stringify(payload),
                    success: function (result) {
                        $('#edituser-modal').modal('hide');
                    },
                    error: function (e) {
                        console.log(e)
                    }
                });
            }
            return false;
        });

        $('body').on('click', '#add-user-opt', function () {
            $('#adduser-form').trigger('reset');
            adduserFromValidator.resetForm();
            $('#adduser-modal').modal()
        });

        $('#btn-add-user').on("click", function (event) {
            if ($("#adduser-form").valid()) {
                var newUserStatus = 'pending';
                if ($('#chkIsActive').is(":checked")) {
                    newUserStatus = 'active';
                }
                var payload = {
                    tenantid: parseInt(Cookies.get('tenantid')),
                    username: $('#inputUsername').val(),
                    password: $('#inputPassword').val(),
                    email: $('#inputEmail').val(),
                    status: newUserStatus,
                    apgroups : getCheckedDataScopes('datascope')
                }
                $.post('/dashboard/users', JSON.stringify(payload), function (result) {
                    $('#adduser-modal').modal('hide');
                });
            }
            return false;
        });
    });

    function getCheckedDataScopes(chkboxName) {
        var checkboxes = document.getElementsByName(chkboxName);
        var checkboxesChecked = [];
        for (var i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                checkboxesChecked.push(checkboxes[i].value);
            }
        }
        return checkboxesChecked.length > 0 ? checkboxesChecked : null;
    }
</script>