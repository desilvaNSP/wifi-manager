<div class="wrapper wrapper-content">
    <div class="row">
        <div id="widget-active-accespoint" class="configuration-container col-lg-3">

        </div>
        <div id="widget-inactive-accespoint" class="configuration-container col-lg-3">

        </div>
        <div class="col-lg-3">
            <div class="widget style1 lazur-bg">
                <div class="row">
                    <div class="col-xs-4 text-center">
                        <i class="fa fa-cloud-download fa-5x"></i>
                    </div>
                    <div class="col-xs-8 text-right">
                        <span> Total Access Points </span>
                        <h2 class="font-bold">326</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Access point Map -->
<div class="row">
    <div class="col-lg-12">
        <div class="ibox-content float-e-margins">
            <h2>Access Point Map</h2>
            <div id="world-map" class="world-map">
                <div id="popup"></div>
            </div>
            <div id="info">&nbsp;</div>
        </div>
    </div>
</div>

<div class="row" style="margin-top: 20px ">
    <div class="col-lg-12">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5> Wifi Locations</h5>

                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-wrench"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href="#" id="add-wifilocation-btn">Add New Location</a>
                        <li><a href="#" id="add-wifigroup-btn">Add New Group</a>
                        </li>
                    </ul>
                    <a class="close-link">
                        <i class="fa fa-times"></i>
                    </a>
                </div>
            </div>
            <div class="ibox-content">

                <table id="locationtable" class="table table-striped table-bordered table-hover dataTables-location">
                    <thead>
                    <tr>
                        <th>Id</th>
                        <th>Location Group</th>
                        <th>MAC</th>
                        <th>AP Name</th>
                        <th>SSID</th>
                        <th>BSSID</th>
                        <th>Longitude</th>
                        <th>Latitude</th>
                        <th>Settings</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th>Location</th>
                        <th></th>
                        <th></th>
                        <th>SSID</th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                    </thead>
                </table>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirm-delete-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <h4 class="modal-title">Delete Location</h4>
            </div>
            <div class="modal-body" id="deletelocation-body">
                <p><strong>Are you sure you want to delete the location?</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">No</button>
                <button type="button" class="btn btn-primary" id="delete-location">Yes</button>
            </div>
        </div>
    </div>
</div>

<div id="add-wifi-location-modal-content"></div>

<script>
    $(document).ready(function () {
        var activePeriodFrom, activePeriodTo;

        activePeriodTo = moment().format('YYYY-MM-DD')
        activePeriodFrom = moment().subtract(500, 'days').format('YYYY-MM-DD');
        var treshold = 2;


        console.log(activePeriodFrom)
        console.log(activePeriodTo)
        $.get('/wifi/locations/apcounts?from=' + activePeriodFrom + '&to=' + activePeriodTo + '&treshold=' + treshold, function (data) {
            var activeUsercount = 589;
            $.get('components/widgets/statistic-configuration.html', function (template) {
                var rendered = Mustache.render(template, {
                    caption: 'Active Access Points',
                    value: activeUsercount,
                    cardname: 'activeap',
                    widgetbg: 'lazur-bg',
                });
                var optionsHTML = '<div class="form-group row">' +
                        '<div class="col-sm-12"><input class="input-s-sm" placeholder="Treshold Days">' +
                        '</div>' +
                        '</div>' +
                        '<div class="text-right row">' +
                        '<a class="btn btn-xs btn-info options-done"><i class="fa fa-check" ></i>Done</a>' +
                        '</div>';

                var iconHTML1 = '<div class="row row-centered app-listing">' +
                        '<div class="app-listing-loader">' +
                        '<div class="loading-logo">' +
                        '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="5em" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 14 14" enable-background="new 0 0 14 14" xml:space="preserve">' +
                        '<path class="circle" stroke-width="1.4" stroke-miterlimit="10" d="M6.534,' +
                        '0.748C7.546,0.683,8.578,0.836,9.508,1.25 c1.903,0.807,3.339,2.615,3.685,4.654c0.244,' +
                        '1.363,0.028,2.807-0.624,4.031c-0.851,1.635-2.458,2.852-4.266,3.222 c-1.189,0.25-2.45,' +
                        '0.152-3.583-0.289c-1.095-0.423-2.066-1.16-2.765-2.101C1.213,9.78,0.774,8.568,0.718,' +
                        '7.335 C0.634,5.866,1.094,4.372,1.993,3.207C3.064,1.788,4.76,0.867,6.534,0.748z"/>' +
                        '<path class="pulse-line" stroke-width="0.55" stroke-miterlimit="10" d="M12.602,' +
                        '7.006c-0.582-0.001-1.368-0.001-1.95,0 c-0.491,0.883-0.782,1.4-1.278,2.28C8.572,' +
                        '7.347,7.755,5.337,6.951,3.399c-0.586,1.29-1.338,3.017-1.923,' +
                        '4.307 c-1.235,0-2.38-0.002-3.615,0"/>' +
                        '</svg>' +
                        '<div class="signal"></div>' +
                        '</div>' +
                        '</div>' +
                        '</div>'

                $('#widget-active-accespoint').html(rendered);
                $('#widget-active-accespoint .option-card').html(optionsHTML)
                $('#widget-active-accespoint .icon-content-card').html(iconHTML1)

                var card = $('#activeap');
                $('.configuration_card#activeap span').on('click', function () {
                    card.addClass('swivel-effect-180');
                    if (card.hasClass('swivel-effect-0')) {
                        card.removeClass('swivel-effect-0');
                    }
                });
                $('div#activeap .options-done').on('click', function () {
                    $.get('/wifi/locations/apcounts?from=' + activePeriodFrom + '&to=' + activePeriodTo, function (data) {
                        $('div#activeap h2#value').html("323");
                        card.addClass('swivel-effect-0');
                    });
                });

            });
        });

        $.get('components/widgets/statistic-configuration.html', function (template) {
            var rendered = Mustache.render(template, {
                caption: 'Inactive Access Points',
                value: 273,
                cardname: 'inactiveap',
                widgetbg: 'red-bg',
            });
            var optionsHTML = '<div class="form-group row">' +
                    '<div class="col-sm-12"><input class="input-s-sm" placeholder="Treshold Days">' +
                    '</div>' +
                    '</div>' +
                    '<div class="text-right row">' +
                    '<a class="btn btn-xs btn-info options-done"><i class="fa fa-check" ></i>Done</a>' +
                    '</div>';

            var iconHTML2 = '<i class="fa fa-chain-broken -o fa-5x"></i>'

            $('#widget-inactive-accespoint').html(rendered);
            $('#widget-inactive-accespoint .option-card').html(optionsHTML)
            $('#widget-inactive-accespoint .icon-content-card').html(iconHTML2)

            var card = $('#inactiveap');
            $('.configuration_card#inactiveap span').on('click', function () {
                card.addClass('swivel-effect-180');
                if (card.hasClass('swivel-effect-0')) {
                    card.removeClass('swivel-effect-0');
                }
            });
            $('div#inactiveap .options-done').on('click', function () {
                $('div#inactiveap h2#value').html("122");
                card.addClass('swivel-effect-0');
            });

        });

        var serverOriginUrl = window.location.origin;

        var map = new ol.Map({
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            renderer: 'canvas',
            target: 'world-map',
            view: new ol.View({
                center: [0, 0],
                zoom: 2
            })
        });

        var iconStyle = new ol.style.Style({
            image: new ol.style.Icon(({
                anchor: [0.5, 46],
                anchorXUnits: 'fraction',
                anchorYUnits: 'pixels',
                opacity: 0.75,
                src: 'map-data/icon.png'
            }))
        });

        var locationTable = $('.dataTables-location').DataTable({
            responsive: true,
            orderCellsTop: true,
            autoWidth: false,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
            "ajax": {
                "url": serverOriginUrl + "/wifi/" + Cookies.get("tenantid") + "/locations",
                "type": "GET",
                "error": function (e) {
                },
                "dataSrc": function (d) {
                    updateMarkers(d, map, iconStyle)
                    return d
                }
            },
            columns: [
                {"data": "locationid", "width": "3%"},
                {"data": "groupname", "width": "10%"},
                {"data": "mac", "width": "10%"},
                {"data": "apname", "width": "5%"},
                {"data": "ssid", "width": "5%"},
                {"data": "bssid", "width": "10%"},
                {"data": "longitude", "width": "5%"},
                {"data": "latitude", "width": "5%"},
                {
                    "data": null,
                    "defaultContent": "<div class='btn-group'><button class='btn btn-white btn-xs dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'><i class='fa fa-gear'></i></button><ul class='dropdown-menu'><li><a href='#' id='setting-edit-location'>Edit</a></li><li><a href='#' id='setting-delete-location'>Delete</a></li></ul></div>",
                    "width": "1%",
                    "className": 'center',
                    "sortable": false
                }
            ],
            dom: "<'dt-toolbar'<'col-xs-12 col-sm-6'lf><'col-sm-6 col-xs-6 hidden-xs'CT>r>" +
            "t" +
            "<'dt-toolbar-footer'<'col-sm-6 col-xs-12 hidden-xs'i><'col-sm-6 col-xs-12'p>>",
            tableTools: {
                "aButtons": [
                    {
                        "sExtends": "copy",
                        "sButtonText": "Copy",
                        "mColumns": "visible"
                    },
                    {
                        "sExtends": "csv",
                        "sButtonText": "CSV",
                        "mColumns": "visible"
                    },
                    {
                        "sExtends": "xls",
                        "sButtonText": "Excel",
                        "mColumns": "visible"
                    },
                    {
                        "sExtends": "pdf",
                        "sButtonText": "PDF",
                        "mColumns": "visible"
                    },
                    {
                        "sExtends": "print",
                        "sButtonText": "Print",
                        "mColumns": "visible"
                    }
                ],
                "sSwfPath": "js/plugins/dataTables/swf/copy_csv_xls_pdf.swf"
            }
        });

        $.get('/wifi/' + Cookies.get('tenantid') + '/locations/groups', function (locationGroups) {
            $('.dataTables-location').dataTable().columnFilter({
                sPlaceHolder: "head:before",
                aoColumns: [
                    null,
                    {type: "select", values: locationGroups},
                    null,
                    null,
                    {"bSortable": false},
                    null,
                    null,
                    null,
                    null
                ]
            });
        });

        $('.dataTables-location tbody').on('click', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
            }
            else {
                locationTable.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
            }
        });

        var selectedLocation;

        $('#delete-location').on("click", function (event) {
            $.ajax({
                url: '/wifi/' + Cookies.get('tenantid') + '/locations/' + selectedLocation.mac + '/' + selectedLocation.ssid + '/' + selectedLocation.groupname,
                type: 'DELETE',
                beforeSend: function () {
                    $("#deletelocation-body").loadingOverlay({
                        loadingText: 'Updating location'
                    });
                },
                success: function (result) {
                    $("#deletelocation-body").loadingOverlay('remove');
                    $('#confirm-delete-modal').modal('hide');
                    locationTable.ajax.reload();
                },
                error: function (e) {
                }
            });
            return false;
        });

        $('.dataTables-location tbody').on('click', '#setting-delete-location', function () {
            selectedLocation = locationTable.row($(this).parents('tr')).data();
            $('#confirm-delete-modal').modal()
        });

        $('.dataTables-location tbody').on('click', '#setting-edit-location', function () {
            var locations;
            selectedLocation = locationTable.row($(this).parents('tr')).data();
            var locationsAjax = $.get('/wifi/' + Cookies.get('tenantid') + '/locations/groups', function (result) {
                locations = result;
                var index = locations.indexOf(selectedLocation.groupname);
                if (index > -1) {
                    locations.splice(index, 1);
                }
            });
            var updateWifiLocationFromValidator;
            $.when(locationsAjax).done(function () {
                $.get('components/wifi-locationupdate-modal.html', function (template) {
                    var rendered = Mustache.render(template, {
                        locations: locations,
                        groupname: selectedLocation.groupname,
                        mac: selectedLocation.mac,
                        apname: selectedLocation.apname,
                        ssid: selectedLocation.ssid,
                        bssid: selectedLocation.bssid,
                        longitude: selectedLocation.longitude,
                        latitude: selectedLocation.longitude
                    });

                    $('#add-wifi-location-modal-content').html(rendered);
                    $('#update-wifilocation-modal').modal();
                    updateWifiLocationFromValidator = $("#update-wifilocation-form").validate({
                        rules: {
                            mac: {
                                required: true,
                                minlength: 17,
                                maxlength: 17
                            },
                            apname: {
                                required: true,
                                minlength: 5,
                                maxlength: 25
                            },
                            ssid: {
                                required: true,
                                minlength: 1
                            },
                            bssid: {
                                required: true,
                                minlength: 17,
                                maxlength: 17,
                            },
                            longitude: {
                                required: false,
                                number: true
                            },
                            latitude: {
                                required: false,
                                number: true
                            }
                        },
                        messages: {
                            mac: "Please enter a correct MAC address in xx-xx-xx-xx-xx-xx form",
                            bssid: "Please enter a correct BSSID address in xx-xx-xx-xx-xx-xx form"
                        }
                    });
                });
            });

            // update wifi location
            $("#add-wifi-location-modal-content").off('click').on("click", '#btn-update-wifilocation', function (event) {
                var payload = {
                    tenantid: parseInt(Cookies.get('tenantid')),
                    locationid: selectedLocation.locationid,
                    mac: $('#edit-mac').val(),
                    apname: $('#edit-apname').val(),
                    ssid: $('#edit-ssid').val(),
                    bssid: $('#edit-bssid').val(),
                    latitude: parseFloat($('#edit-latitude').val()),
                    longitude: parseFloat($('#edit-longitude').val()),
                    groupname: $('#edit-group-name').val()
                };
                $("#editlocation-body").loadingOverlay({
                    loadingText: 'Updating location'
                });
                $.post('/wifi/locationsupdate', JSON.stringify(payload), function (result) {
                    $("#editlocation-body").loadingOverlay('remove');
                    $('#update-wifilocation-modal').modal('hide');
                    locationTable.ajax.reload();
                });
            });
        });

        $("#add-wifilocation-btn").on('click', function () {
            var locations;
            var locationsAjax = $.get('/wifi/' + Cookies.get('tenantid') + '/locations/groups', function (result) {
                locations = result
            });
            var addWifiLocationFromValidator;
            $.when(locationsAjax).done(function () {
                $.get('components/wifi-location-modal.html', function (template) {
                    var rendered = Mustache.render(template, {
                        locations: locations
                    });
                    $('#add-wifi-location-modal-content').html(rendered);
                    $('#add-wifilocation-modal').modal();

                    addWifiLocationFromValidator = $("#add-wifilocation-form").validate({
                        rules: {
                            mac: {
                                required: true,
                                minlength: 17,
                                maxlength: 17,
                            },
                            ssid: {
                                required: true,
                                minlength: 1
                            },
                            bssid: {
                                required: true,
                                minlength: 17,
                                maxlength: 17,
                            },
                            longitude: {
                                required: false,
                                number: true
                            },
                            latitude: {
                                required: false,
                                number: true
                            }
                        },
                        messages: {
                            mac: "Please enter a correct MAC address in xx-xx-xx-xx-xx-xx form",
                            bssid: "Please enter a correct BSSID address in xx-xx-xx-xx-xx-xx form"
                        }
                    });
                });
            });

            $("#add-wifi-location-modal-content").off('click').on("click", '#btn-add-wifilocation', function (event) {
                if (addWifiLocationFromValidator.valid()) {
                    var payload = {
                        tenantid: parseInt(Cookies.get('tenantid')),
                        mac: $('#input-mac').val(),
                        apname: $('#input-apname').val(),
                        ssid: $('#input-ssid').val(),
                        bssid: $('#input-bssid').val(),
                        latitude: parseFloat($('#input-latitude').val()),
                        longitude: parseFloat($('#input-longitude').val()),
                        groupname: $('#input-group-name').val()
                    };
                    $("#addlocation-body").loadingOverlay({
                        loadingText: 'Creating Location'
                    });
                    $.post('/wifi/locations', JSON.stringify(payload), function (result) {
                        $("#addlocation-body").loadingOverlay('remove');
                        $('#add-wifilocation-modal').modal('hide');
                        locationTable.ajax.reload();
                    });
                }
                return false;
            });
        });

        $("#add-wifigroup-btn").on('click', function () {
            var addWifiGroupFromValidator;
            $.get('components/wifi-group-modal.html', function (template) {
                var rendered = Mustache.render(template, {
                    locations: ""
                });
                $('#add-wifi-location-modal-content').html(rendered);
                $('#add-wifigroup-modal').modal();

                addWifiGroupFromValidator = $("#add-wifigroup-form").validate({
                    rules: {
                        groupname: {
                            required: true,
                            minlength: 1
                        },
                        groupsymbol: {
                            required: true,
                            minlength: 1
                        }
                    }
                });
            });

            $("#add-wifi-location-modal-content").off('click').on("click", '#btn-add-wifigroup', function (event) {
                if (addWifiGroupFromValidator.valid()) {
                    var payload = {
                        tenantid: parseInt(Cookies.get('tenantid')),
                        groupname: $('#input-group-name').val(),
                        groupsymbol: $('#input-group-symbol').val()
                    };
                    $.post('/wifi/locations/groups', JSON.stringify(payload), function (result) {
                        $('#add-wifigroup-modal').modal('hide');
                    });
                }
                return false;
            });
        });
    });
</script>

