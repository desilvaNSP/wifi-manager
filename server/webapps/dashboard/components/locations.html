<div class="feature-details-container">
    <div class="row">
        <div id="widget-active-accespoint" class="configuration-container col-lg-3">
            <div class="sk-spinner sk-spinner-three-bounce">
                <div class="sk-bounce1"></div>
                <div class="sk-bounce2"></div>
                <div class="sk-bounce3"></div>
            </div>
        </div>
        <div id="widget-inactive-accespoint" class="configuration-container col-lg-3">
            <div class="sk-spinner sk-spinner-three-bounce">
                <div class="sk-bounce1"></div>
                <div class="sk-bounce2"></div>
                <div class="sk-bounce3"></div>
            </div>
        </div>
        <div id="widget-distinct-mac" class="configuration-container col-lg-3">
            <div class="sk-spinner sk-spinner-three-bounce">
                <div class="sk-bounce1"></div>
                <div class="sk-bounce2"></div>
                <div class="sk-bounce3"></div>
            </div>
        </div>
    </div>
</div>
<!-- Access point Map -->
<div class="row">
    <div class="col-lg-12">
        <div class="ibox-content float-e-margins">
            <h2>Access Point Map</h2>
            <div id="world-map" class="world-map">
                <div id="popup"></div>
            </div>
            <div id="info">&nbsp;</div>
        </div>
    </div>
</div>

<div class="row" style="margin-top: 20px ">
    <div class="col-lg-12">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5> Wifi Locations</h5>

                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                    <a class="close-link">
                        <i class="fa fa-times"></i>
                    </a>
                </div>
            </div>
            <div class="ibox-content">

                <table id="locationtable" class="table table-striped table-bordered table-hover dataTables-location">
                    <thead>
                    <tr>
                        <th>Id</th>
                        <th>Location Group</th>
                        <th>MAC</th>
                        <th>AP Name</th>
                        <th>SSID</th>
                        <th>BSSID</th>
                        <th>Address</th>
                        <th>Longitude</th>
                        <th>Latitude</th>
                        <th>Settings</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th>Location</th>
                        <th></th>
                        <th></th>
                        <th>SSID</th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                    </thead>
                </table>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirm-delete-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <h4 class="modal-title">Delete Location</h4>
            </div>
            <div class="modal-body" id="deletelocation-body">
                <p><strong>Are you sure you want to delete the location?</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">No</button>
                <button type="button" class="btn btn-primary" id="delete-location">Yes</button>
            </div>
        </div>
    </div>
</div>

<div id="add-wifi-location-modal-content"></div>

<script type="">

    _apPeriodFrom = 0, _apPeriodTo = 0;

    $(document).ready(function () {

        var locationTable;
        var mapConfigs;

         _apPeriodTo = moment().format('YYYY-MM-DD')
         _apPeriodFrom = moment().subtract(500, 'days').format('YYYY-MM-DD');

        var serverOriginUrl = window.location.origin;


        initFeatureWidgets();

        mapConfigs = initAccessPointMap();

        locationTable = initLocationTable(serverOriginUrl, mapConfigs);

        $('.dataTables-location tbody').on('click', '#setting-delete-location', function () {
            loadDeleteLocationModal(locationTable, $(this).parents('tr'))
        });

        $('.dataTables-location tbody').on('click', '#setting-edit-location', function () {
            loadUpdateLocationModal(locationTable, $(this).parents('tr'));
        });

    });

    /**
     * Initialization of feature widgets
     */
    function initFeatureWidgets() {
        renderFeatureDetailsWidgets({
            url: '/wifi/ap/activecount?from=' + _apPeriodFrom + '&to=' + _apPeriodTo + '&threshold=' + Cookies.get("activeap-treshold"),
            templateUrl: 'activeap-details.html',
            containerId: '#widget-active-accespoint',
            defaultTreshold: Cookies.get("activeap-treshold")
        });
        renderFeatureDetailsWidgets({
            url: '/wifi/ap/inactivecount?from=' + _apPeriodFrom + '&to=' + _apPeriodTo + '&threshold=' + Cookies.get("inactiveap-treshold"),
            templateUrl: 'inactive-details.html',
            containerId: '#widget-inactive-accespoint',
            defaultTreshold: Cookies.get("inactiveap-treshold")
        });
        renderFeatureDetailsWidgets({
            url: '/wifi/ap/distinctcount?from=' + _apPeriodFrom + '&to=' + _apPeriodTo,
            templateUrl: 'distinctmac-details.html',
            containerId: '#widget-distinct-mac'
        });
    }


    /**
     * Initialization of Access point map using Openlayer map
     * @return {Object} mapConfigs
     */
    function initAccessPointMap() {
        var mapConfigs = {};
        mapConfigs.map = new ol.Map({
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            renderer: 'canvas',
            target: 'world-map',
            view: new ol.View({
                center: [0, 0],
                zoom: 2
            })
        });

        mapConfigs.iconStyle = new ol.style.Style({
            image: new ol.style.Icon(({
                anchor: [0.5, 46],
                anchorXUnits: 'fraction',
                anchorYUnits: 'pixels',
                opacity: 0.75,
                src: 'map-data/icon.png'
            }))
        });
        return mapConfigs
    }


    /**
     * Initialization of location table
     * @param {string} serverOriginUrl
     * @return {Object} locationTable
     */
    function initLocationTable(serverOriginUrl, mapConfigs) {
        var locationTable = $('.dataTables-location').DataTable({
            responsive: true,
            orderCellsTop: true,
            autoWidth: false,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
            "ajax": {
                "url": serverOriginUrl + "/wifi/" + Cookies.get("tenantid") + "/locations",
                "type": "GET",
                "error": function (e) {
                },
                "dataSrc": function (d) {
                    updateMarkers(d, mapConfigs.map, mapConfigs.iconStyle);
                    return d
                }
            },
            columns: [
                {"data": "locationid", "width": "3%"},
                {"data": "groupname", "width": "10%"},
                {"data": "mac", "width": "10%"},
                {"data": "apname", "width": "5%"},
                {"data": "ssid", "width": "5%"},
                {"data": "bssid", "width": "10%"},
                {"data": "address", "width": "5%"},
                {"data": "longitude", "width": "10%"},
                {"data": "latitude", "width": "5%"},
                {
                    "data": null,
                    "defaultContent": "<div class='btn-group'><button class='btn btn-white btn-xs dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'><i class='fa fa-gear'></i></button><ul class='dropdown-menu'><li><a href='#' id='setting-edit-location'>Edit</a></li><li><a href='#' id='setting-delete-location'>Delete</a></li></ul></div>",
                    "width": "1%",
                    "className": 'center',
                    "sortable": false
                }
            ],
            dom: "<'dt-toolbar'<'col-xs-12 col-sm-4'lf><'col-sm-8 col-xs-6 hidden-xs'CT>r>" +
            "t" +
            "<'dt-toolbar-footer'<'col-sm-6 col-xs-12 hidden-xs'i><'col-sm-6 col-xs-12'p>>",
            tableTools: {
                "aButtons": [
                    {
                        "sExtends": "text",
                        "sButtonText": "Add New Location",
                        "fnClick": function (nButton, oConfig, oFlash) {
                            var addWifiLocationFromValidator = loadAddLocationModal(locationTable);
                            addWifiLocationFromValidator.resetForm();
                        }
                    },
                    {
                        "sExtends": "text",
                        "sButtonText": "Add New Group",
                        "sButtonClass": "datatable-toolbtns",
                        "fnClick": function (nButton, oConfig, oFlash) {
                            var addWifiGroupFromValidator = loadAddLocationGroupModal(locationTable);
                            addWifiGroupFromValidator.resetForm();
                        }
                    },
                    {
                        "sExtends": "copy",
                        "sButtonText": "Copy",
                        "mColumns": "visible"
                    },
                    {
                        "sExtends": "csv",
                        "sButtonText": "CSV",
                        "mColumns": "visible"
                    },
                    {
                        "sExtends": "xls",
                        "sButtonText": "Excel",
                        "mColumns": "visible"
                    },
                    {
                        "sExtends": "pdf",
                        "sButtonText": "PDF",
                        "mColumns": "visible"
                    },
                    {
                        "sExtends": "print",
                        "sButtonText": "Print",
                        "mColumns": "visible"
                    }
                ],
                "sSwfPath": "js/plugins/dataTables/swf/copy_csv_xls_pdf.swf"
            }
        });

        $.get('/wifi/' + Cookies.get('tenantid') + '/locations/groups', function (locationGroups) {
            $('.dataTables-location').dataTable().columnFilter({
                sPlaceHolder: "head:before",
                aoColumns: [
                    null,
                    {type: "select", values: locationGroups},
                    null,
                    null,
                    {"bSortable": false},
                    null,
                    null,
                    null,
                    null
                ]
            });
        });

        $('.dataTables-location tbody').on('click', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
            }
            else {
                locationTable.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
            }
        });
        return locationTable;
    }


    /**
     * Load modal for adding access point or ap location
     * @param {Object} locationTable
     * @return {Object} addLocationValidatorConfigs
     */
    function loadAddLocationModal(locationTable) {
        var locations;
        var locationsAjax = $.get('/wifi/' + Cookies.get('tenantid') + '/locations/groups', function (result) {
            locations = result
        });
        var addLocationValidatorConfigs = null;
        $.when(locationsAjax).done(function () {
            $.get('components/wifi-location-modal.html', function (template) {
                var rendered = Mustache.render(template, {
                    locations: locations
                });
                $('#add-wifi-location-modal-content').html(rendered);
                $('#add-wifilocation-modal').modal();

                addLocationValidatorConfigs = addLocationFormValidatorRules();

                $('#input-geoaddress').on("blur", function (event) {
                    getLatLangOnGeolocationAddress(this.value, $('#input-latitude'), $('#input-longitude'), $('#input-errmsg-apaddr'));
                });
            });
        });
        $("#add-wifi-location-modal-content").off('click').on('click', '#btn-add-wifilocation', function (event) {
            addLocationFormData(locationTable);
        });
        return addLocationValidatorConfigs;
    }

    function addLocationFormValidatorRules() {
        return $("#add-wifilocation-form").validate({
            rules: {
                mac: {
                    required: true,
                    minlength: 17,
                    maxlength: 17,
                },
                ssid: {
                    required: true,
                    minlength: 1
                },
                bssid: {
                    required: true,
                    minlength: 17,
                    maxlength: 17,
                },
                geoaddress: {
                    required: true
                },
                longitude: {
                    required: false,
                    number: true
                },
                latitude: {
                    required: false,
                    number: true
                }
            },
            messages: {
                mac: "Please enter a correct MAC address in xx-xx-xx-xx-xx-xx form",
                bssid: "Please enter a correct BSSID address in xx-xx-xx-xx-xx-xx form",
                geoaddress: "please enter geo location address"
            }
        });
    }

    function addLocationFormData(locationTable) {
        if ($("#add-wifilocation-form").valid()) {
            var payload = {
                tenantid: parseInt(Cookies.get('tenantid')),
                mac: $('#input-mac').val(),
                apname: $('#input-apname').val(),
                ssid: $('#input-ssid').val(),
                bssid: $('#input-bssid').val(),
                address: $('#input-geoaddress').val(),
                latitude: parseFloat($('#input-latitude').val()),
                longitude: parseFloat($('#input-longitude').val()),
                groupname: $('#input-group-name').val()
            };
            $("#addlocation-body").loadingOverlay({
                loadingText: 'Creating Location'
            });
            $.post('/wifi/locations', JSON.stringify(payload), function (result) {
                $("#addlocation-body").loadingOverlay('remove');
                $('#add-wifilocation-modal').modal('hide');
                locationTable.ajax.reload();
            });
        }
        return false;
    }


    /**
     * Load modal for update ap location
     * @param {Object} locationTable
     * @return {Object} jqRawElement
     */
    function loadUpdateLocationModal(locationTable, jqRawElement) {
        var locations;
        var selectedLocation;
        var updateLocationFromValidator;

        selectedLocation = locationTable.row(jqRawElement).data();

        var locationsAjax = $.get('/wifi/' + Cookies.get('tenantid') + '/locations/groups', function (result) {
            locations = result;
            var index = locations.indexOf(selectedLocation.groupname);
            if (index > -1) {
                locations.splice(index, 1);
            }
        });
        $.when(locationsAjax).done(function () {
            $.get('components/wifi-locationupdate-modal.html', function (template) {
                var rendered = Mustache.render(template, {
                    locations: locations,
                    groupname: selectedLocation.groupname,
                    mac: selectedLocation.mac,
                    apname: selectedLocation.apname,
                    ssid: selectedLocation.ssid,
                    bssid: selectedLocation.bssid,
                    address: selectedLocation.address,
                    longitude: selectedLocation.longitude,
                    latitude: selectedLocation.latitude
                });
                $('#add-wifi-location-modal-content').html(rendered);
                $('#update-wifilocation-modal').modal();

                updateLocationFromValidator = updateLocationFormValidatorRules();

                $('#edit-address').on("blur", function (event) {
                    getLatLangOnGeolocationAddress(this.value, $('#edit-latitude'), $('#edit-longitude'), $('#edit-errmsg-apaddr'));
                });
            });
        });

        $("#add-wifi-location-modal-content").off('click').on("click", '#btn-update-wifilocation', function (event) {
            updateSelectedLocation(locationTable, selectedLocation);
        });
    }

    function updateLocationFormValidatorRules() {
        return $("#update-wifilocation-form").validate({
            rules: {
                mac: {
                    required: true,
                    minlength: 17,
                    maxlength: 17
                },
                apname: {
                    required: true,
                    minlength: 5,
                    maxlength: 25
                },
                ssid: {
                    required: true,
                    minlength: 1
                },
                bssid: {
                    required: true,
                    minlength: 17,
                    maxlength: 17,
                },
                address: {
                    required: true
                },
                longitude: {
                    required: false,
                    number: true
                },
                latitude: {
                    required: false,
                    number: true
                }
            },
            messages: {
                mac: "Please enter a correct MAC address in xx-xx-xx-xx-xx-xx form",
                bssid: "Please enter a correct BSSID address in xx-xx-xx-xx-xx-xx form"
            }
        });
    }

    function updateSelectedLocation(locationTable, selectedLocation) {
        if ($("#update-wifilocation-form").valid()) {
            var payload = {
                tenantid: parseInt(Cookies.get('tenantid')),
                locationid: selectedLocation.locationid,
                mac: $('#edit-mac').val(),
                apname: $('#edit-apname').val(),
                ssid: $('#edit-ssid').val(),
                bssid: $('#edit-bssid').val(),
                address: $('#edit-address').val(),
                latitude: parseFloat($('#edit-latitude').val()),
                longitude: parseFloat($('#edit-longitude').val()),
                groupname: $('#edit-group-name').val()
            };
            $("#editlocation-body").loadingOverlay({
                loadingText: 'Updating location'
            });
            $.post('/wifi/locationsupdate', JSON.stringify(payload), function (result) {
                $("#editlocation-body").loadingOverlay('remove');
                $('#update-wifilocation-modal').modal('hide');
                locationTable.ajax.reload();
            });
        }
    }

    /**
     * Load modal for delete ap location
     * @param {Object} locationTable
     * @return {Object} jqRawElement
     */
    function loadDeleteLocationModal(locationTable, jqRawElement) {
        var selectedLocation;
        selectedLocation = locationTable.row(jqRawElement).data();
        $('#confirm-delete-modal').modal();
        $('#delete-location').on("click", function (event) {
            deleteSelectedLocation(locationTable, selectedLocation);
        });
    }

    function deleteSelectedLocation(locationTable, selectedLocation) {
        $.ajax({
            url: '/wifi/' + Cookies.get('tenantid') + '/locations/' + selectedLocation.mac + '/' + selectedLocation.ssid + '/' + selectedLocation.groupname,
            type: 'DELETE',
            beforeSend: function () {
                $("#deletelocation-body").loadingOverlay({
                    loadingText: 'Updating location'
                });
            },
            success: function (result) {
                $("#deletelocation-body").loadingOverlay('remove');
                $('#confirm-delete-modal').modal('hide');
                locationTable.ajax.reload();
            },
            error: function (e) {
            }
        });
        return false;
    }


    /**
     * Load modal for adding ap location groups
     * @return {Object} addLocationGroupsValidatorConfigs
     */
    function loadAddLocationGroupModal(locationTable) {
        var addLocationGroupsValidatorConfigs = null;
        $.get('components/wifi-group-modal.html', function (template) {
            var rendered = Mustache.render(template, {
                locations: ""
            });
            $('#add-wifi-location-modal-content').html(rendered);
            $('#add-wifigroup-modal').modal();

            addLocationGroupsValidatorConfigs = addLocationGruopFormValidatorRules();
        });
        $("#add-wifi-location-modal-content").off('click').on("click", '#btn-add-wifigroup', function (event) {
            addLocationGroup(locationTable);
        });
        return addLocationGroupsValidatorConfigs;
    }

    function addLocationGroup(locationTable) {
        if ($("#add-wifigroup-form").valid()) {
            var payload = {
                tenantid: parseInt(Cookies.get('tenantid')),
                groupname: $('#input-group-name').val(),
                groupsymbol: $('#input-group-symbol').val()
            };
            $.post('/wifi/locations/groups', JSON.stringify(payload), function (result) {
                $('#add-wifigroup-modal').modal('hide');
                locationTable.ajax.reload();
            });
        }
        return false;
    }

    function addLocationGruopFormValidatorRules() {
        return $("#add-wifigroup-form").validate({
            rules: {
                groupname: {
                    required: true,
                    minlength: 1
                },
                groupsymbol: {
                    required: true,
                    minlength: 1
                }
            }
        });
    }


    /**
     * Get Longitude and Latitude from address using google geocoder
     * @param {String} address
     */
    function getLatLangOnGeolocationAddress(address, jqEleLat, jqEleLng, jqEleMsg) {
        geocodeAddress(address, function (lngLatObj, valid) {
            jqEleLat.val("");
            jqEleLng.val("");
            if (!valid) {
                jqEleMsg.show().html("Cannot extract Longtitude and Latitude for this Location Address | Google API");
            } else {
                jqEleMsg.hide();
                jqEleLat.val(lngLatObj.lat());
                jqEleLng.val(lngLatObj.lng());
            }
        });
    }

    /**
     * Render feature details widgets
     * @param {Object} details
     */
    function renderFeatureDetailsWidgets(details) {
        var detailsRequest, count;
        detailsRequest = $.get(details.url, function (data) {
            count = data;
        });
        $.when(detailsRequest).done(function () {
            $.get('components/widgets/featuredetails-widgets/' + details.templateUrl, function (template) {
                var rendered = Mustache.render(template, {
                    value: count
                });
                $(details.containerId).html(rendered);
            });
        });
    }

    /**
     * Check validity and LatLang of address from geocoder google api
     * @param {string} address
     * @param {callback} callback
     */
    function geocodeAddress(address, callback) {
        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({'address': address}, function (results, status) {
            if (status === google.maps.GeocoderStatus.OK) {
                callback(results[0].geometry.location, true)
            } else {
                callback(null, false)
            }
        });
    }


</script>

