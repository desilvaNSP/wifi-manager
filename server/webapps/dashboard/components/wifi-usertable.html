<div class="col-lg-12">
    <div class="ibox float-e-margins">
        <div class="ibox-title">
            <h5>Wi-Fi user table</h5>

            <div class="ibox-tools">
                <a class="collapse-link">
                    <i class="fa fa-chevron-up"></i>
                </a>
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                    <i class="fa fa-wrench"></i>
                </a>
                <ul class="dropdown-menu dropdown-user">
                    <li><a href="#" id="add-user-opt">Add User</a></li>
                    <li><a id="change-clo-visibility" role="button" data-toggle="collapse" href="#collapseExample"
                           aria-expanded="false" aria-controls="collapseExample">Change Column Visibility</a></li>
                </ul>
                <a class="close-link">
                    <i class="fa fa-times"></i>
                </a>
            </div>
        </div>
        <div class="ibox-content">

            <table class="table table-striped table-bordered table-hover dataTables-user">
                <thead>
                <tr>
                    <th>Username</th>
                    <th>ACL</th>
                    <th>Group</th>
                    <th>Visit count</th>
                    <th>Acct start Time</th>
                    <th>Acct Stop Time</th>
                    <th>Acct Last Updated Time</th>
                    <th>Settings</th>
                </tr>
                <tr>
                    <th></th>
                    <th>ACL</th>
                    <th>Location</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<div class="modal inmodal" id="adduser-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <i class="fa fa-user-md modal-icon"></i>
                <h4 class="modal-title">Add WiFi User</h4>
                <small class="font-bold">Add wifi users and configure Access Control</small>
            </div>
            <div class="modal-body">
                <hr>
                <form role="form" id="adduser-form">
                    <div class="form-group">
                        <label for="inputEditUsername">Username</label>
                        <input type="text" class="form-control" id="inputUsername" name="inputusername"
                               placeholder="Username" required>
                    </div>
                    <div class="form-group">
                        <label for="inputEditPassword">Password</label>
                        <input type="text" class="form-control" id="inputPassword" name="inputpassword"
                               placeholder="Password" required>
                    </div>
                    <div class="form-group">
                        <label for="radioIsBlackListed">Access Control</label>
                    </div>
                    <div class="checkbox">
                        <label class="radio inline control-label"><input type="radio" id="radioIsWhiteListed"
                                                                         class="radio" name="role-select"
                                                                         value="whitelisted">White Listed</label><br/>
                        <label class="radio inline control-label"><input type="radio" id="radioIsBlackListed"
                                                                         class="radio" name="role-select"
                                                                         value="blacklisted">Black Listed</label><br/>
                        <label class="radio inline control-label"><input type="radio" id="radioIsNormalUser"
                                                                         class="radio" name="role-select"
                                                                         value="normaluser">Normal User</label><br/>
                    </div>
                    <div class="checkbox">
                        <hr/>
                        <label>
                            <input type="checkbox" id="chkEditIsActive"> Start Accounting
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btn-add-user">Add User</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirm-delete-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <h4 class="modal-title" style="text-align: center">Delete User</h4>
            </div>
            <div class="modal-body">
                <p id="message"><strong>Are you sure you want to delete the user?</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">No</button>
                <button type="button" class="btn btn-primary" id="delete-user">Yes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal inmodal" id="edituser-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <i class="fa fa-user-md modal-icon"></i>
                <h4 class="modal-title">Edit WiFi User</h4>
                <small class="font-bold">Edit wifi users' options</small>
            </div>
            <div class="modal-body">
                <form role="form" id="edituser-form">
                    <div class="form-group">
                        <label for="inputEditUsername">Username</label>
                        <input type="text" class="form-control" id="inputEditUsername" name="editusername"
                               placeholder="Username" required readonly="readonly">
                    </div>
                    <div class="form-group">
                        <label for="inputEditPassword">Password</label>
                        <input type="text" class="form-control" id="inputEditPassword" name="editpassword"
                               placeholder="Password" required>
                    </div>
                    <div class="form-group">
                        <label for="radioEditIsBlackListed">Access Control</label>
                    </div>
                    <div class="checkbox">
                        <label class="radio inline control-label"><input type="radio" id="radioEditIsWhiteListed"
                                                                         class="radio" name="role-select"
                                                                         value="whitelisted">White Listed</label><br/>
                        <label class="radio inline control-label"><input type="radio" id="radioEditIsBlackListed"
                                                                         class="radio" name="role-select"
                                                                         value="blacklisted">Black Listed</label><br/>
                        <label class="radio inline control-label"><input type="radio" id="radioEditIsNormalUser"
                                                                         class="radio" name="role-select"
                                                                         value="normaluser">Normal User</label><br/>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btn-edit-user">Update User</button>
            </div>
        </div>
    </div>
</div>
<script>
    var userTable;
    $(document).ready(function () {
        var serverOriginUrl = window.location.origin;
        userTable = $('.dataTables-user').dataTable({
            responsive: true,
            orderCellsTop: true,
            autoWidth: false,
            serverSide: true,
            processing: true,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
            language: {
                processing: "<div class='sk-spinner sk-spinner-three-bounce'><div class='sk-bounce1'></div><div class='sk-bounce2'></div><div class='sk-bounce3'></div></div>"
            },
            ajax: {
                "url": serverOriginUrl + "/wifi/users",
                "type": "GET",
                "error": function (e) {
                },
                "dataSrc": function (d) {
                    return d.data
                }
            },
            deferRender: true,
            columns: [
                {"data": "username", "width": "15%"},
                {"data": "acl", "width": "7%"},
                {"data": "groupname", "width": "10%"},
                {"data": "visits", "width": "5%"},
                {"data": "acctstarttime", "width": "10%"},
                {"data": "acctstoptime", "width": "10%"},
                {"data": "acctlastupdatedtime", "width": "10%"},
                {
                    "data": null,
                    "defaultContent": "<div class='btn-group'><button class='btn btn-white btn-xs dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'><i class='fa fa-gear'></i></button><ul class='dropdown-menu'><li><a href='#' id='setting-edit-user'>Edit</a></li><li><a href='#' id='setting-change-password'>Change Password</a></li><li><a href='#' id='setting-delete-user'>Delete</a></li></ul></div>",
                    "width": "1%",
                    "className": 'center',
                    "sortable": false
                }
            ],
            dom: "<'dt-toolbar'<'col-xs-12 col-sm-6'l><'col-sm-6 col-xs-6 hidden-xs'CT>r>" +
            "t" +
            "<'dt-toolbar-footer'<'col-sm-6 col-xs-12 hidden-xs'i><'col-sm-6 col-xs-12'p>>",
            tableTools: {
                "sSwfPath": "js/plugins/dataTables/swf/copy_csv_xls_pdf.swf"
            }
        });

        $.get('/wifi/' + Cookies.get('tenantid') + '/locations/groups', function (locationGroups) {
            userTable.columnFilter({
                sPlaceHolder: "head:before",
                aoColumns: [
                    {"bSortable": false},
                    {type: "select", values: ['Whitelisted', 'Blacklisted', 'normal_user']},
                    {type: "select", values: locationGroups},
                    {type: "number" , "bSortable": false},
                    {"bSortable": false},
                    {"bSortable": false},
                    {"bSortable": false},
                    null
                ]
            });
        });

        $('.dataTables-user tbody').on('click', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
            }
            else {
                userTable.api().$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
            }
        });

        var selectedUser, rowToDelete;
        $('#delete-user').on("click", function (event) {
            $.ajax({
                url: '/wifi/' + Cookies.get('tenantid') + '/users/' + selectedUser.username,
                type: 'DELETE',
                success: function (result) {
                    $('#confirm-delete-modal').modal('hide')
                    rawTodelete.remove();
                },
                error: function (e) {
                    console.log(e)
                }
            });
            return false;
        });

        $('.dataTables-user tbody').on('click', '#setting-delete-user', function () {
            selectedUser = userTable.api().row($(this).parents('tr')).data();
            console.log(selectedUser)
            rawTodelete = $(this).closest('tr');
            $('#confirm-delete-modal').modal()
            $('#message').html('<i class="fa fa-warning fa-3x" style="vertical-align: middle;margin-right: 10%"></i>Are you sure you want to delete the user? <strong>' + selectedUser.username + '</strong>');
        });

        $('.dataTables-user tbody').on('click', '#setting-edit-user', function () {
            selectedUser = userTable.api().row($(this).parents('tr')).data();
            //editUserFromValidator.resetForm();
            $('#edituser-modal').modal();
            $("#inputEditUsername").val(selectedUser.username);
            $("#inputEditPassword").val(selectedUser.password);
            if (selectedUser.acl == 'whitelisted') {
                $("#radioEditIsWhiteListed").prop('checked', true);
            } else if (selectedUser.acl == 'blacklisted') {
                $("#radioEditIsBlackListed").prop('checked', true);
            } else {
                $("#radioEditIsNormalUser").prop('checked', true);
            }
        });

        $('#btn-edit-user').on("click", function (event) {
            if ($("#edituser-form").valid()) {
                var newUserStatus = 'pending';
                if ($('#chkEditIsActive').is(":checked")) {
                    newUserStatus = 'active';
                }
                var payload = {
                    username: selectedUser.username,
                    password: selectedUser.password,
                    acl: $('.radio:checked').val(),
                    tenantid: parseInt(Cookies.get('tenantid')),
                };

                $.ajax({
                    url: '/wifi/users',
                    type: 'PUT',
                    contentType: "application/json",
                    data: JSON.stringify(payload),
                    success: function (result) {
                        $('#edituser-modal').modal('hide');
                    },
                    error: function (e) {
                        console.log(e)
                    }
                });
            }
            return false;
        });

        var adduserFromValidator = $("#adduser-form").validate({
            rules: {
                password: {
                    required: true,
                    minlength: 5
                },
                username: {
                    required: true,
                    minlength: 3
                }
            }
        });

        $('body').on('click', '#add-user-opt', function () {
            $('#adduser-form').trigger('reset');
            adduserFromValidator.resetForm();
            $('#adduser-modal').modal()
        });

        $('#btn-add-user').on("click", function (event) {
            if ($("#adduser-form").valid()) {
                var newUserStatus = 'pending';
                if ($('#chkIsActive').is(":checked")) {
                    newUserStatus = 'active';
                }
                var payload = {
                    tenantid: parseInt(Cookies.get('tenantid')),
                    username: $('#inputUsername').val(),
                    password: $('#inputPassword').val(),
                    groupname: "master",
                    acl: $('.radio:checked').val()
                };
                $.post('/wifi/users', JSON.stringify(payload), function (result) {
                    $('#adduser-modal').modal('hide');
                });
            }
            return false;
        });
    });
</script>